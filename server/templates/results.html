{{ template "head" dict "Title" "Pipeline Visualizer" }}
<!-- Breadcrumb navigation -->
<nav
  class="px-3 py-2 sm:px-4 sm:py-3 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 flex items-center gap-1 sm:gap-2 flex-wrap text-sm sm:text-base"
  role="navigation"
  aria-label="Breadcrumb">
  <a href="/pipelines/"
    class="text-blue-600 dark:text-blue-400 hover:underline">Pipelines</a>
  {{ if .RunID }}
  <span class="text-gray-500" aria-hidden="true">/</span>
  <span class="text-gray-800 dark:text-white">Run: {{ .RunID }}</span>
  {{ else }}
  <span class="text-gray-500" aria-hidden="true">/</span>
  <a href="/tasks/"
    class="text-blue-600 dark:text-blue-400 hover:underline">Tasks</a>
  {{ if and .Path (ne .Path "/") }}
  {{ $parts := splitList "/" .Path }}
  {{ $accumulated := "" }}
  {{ range $i, $part := $parts }}
  {{ if $part }}
  {{ $accumulated = printf "%s/%s" $accumulated $part }}
  <span class="text-gray-500" aria-hidden="true">/</span>
  {{ if eq $i (sub (len $parts) 1) }}
  <span class="text-gray-800 dark:text-white">{{ $part }}</span>
  {{ else }}
  <a href="/tasks{{ $accumulated }}/"
    class="text-blue-600 dark:text-blue-400 hover:underline">{{ $part }}</a>
  {{ end }}
  {{ end }}
  {{ end }}
  {{ end }}
  {{ end }}
</nav>

<main id="main-content" role="main">
  <div class="container mx-auto p-4">
    <div
      class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
      <div class="flex items-center gap-3">
        <h1 class="text-3xl font-bold dark:text-white">Pipeline Visualizer</h1>
        {{ if .IsActive }}
        <span
          class="flex items-center gap-2 text-sm text-yellow-600 dark:text-yellow-400">
          <span class="relative flex h-2 w-2">
            <span
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
            <span
              class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
          </span>
          Live
        </span>
        {{ end }}
      </div>
      <div class="flex w-full flex-wrap items-center gap-2 sm:w-auto">
        <!-- Expand/Collapse All -->
        <button id="expand-all"
          class="w-full sm:w-auto px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400"
          aria-label="Expand all tasks"
          title="Expand all tasks (keyboard: e)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor"
            viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round"
              stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <button id="collapse-all"
          class="w-full sm:w-auto px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400"
          aria-label="Collapse all tasks"
          title="Collapse all tasks (keyboard: c)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor"
            viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round"
              stroke-width="2" d="M5 15l7-7 7 7" />
          </svg>
        </button>
        {{ if .RunID }}
        <a href="/runs/{{ .RunID }}/graph"
          class="w-full sm:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
          Graph View
        </a>
        {{ else }}
        <a href="/graph{{ .Path }}/"
          class="w-full sm:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
          Graph View
        </a>
        {{ end }}
      </div>
    </div>

    <!-- Search and Stats Bar -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
      <!-- Search Box -->
      <div class="relative flex-1 max-w-md">
        <svg
          class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none w-4 h-4"
          viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
            clip-rule="evenodd" />
        </svg>
        <input type="text"
          id="task-search"
          class="w-full py-2 pr-3 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-800 text-gray-800 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Filter tasks..."
          aria-label="Filter tasks">
      </div>
      <!-- Summary Stats -->
      <div class="flex items-center gap-3 text-sm" role="status"
        aria-live="polite" aria-label="Task statistics">
        <span
          class="flex items-center gap-1 text-green-600 dark:text-green-400">
          <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"
            aria-hidden="true">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd" />
          </svg>
          <span id="stat-success" aria-label="Successful tasks">0</span>
        </span>
        <span class="flex items-center gap-1 text-red-600 dark:text-red-400">
          <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"
            aria-hidden="true">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd" />
          </svg>
          <span id="stat-failure" aria-label="Failed tasks">0</span>
        </span>
        <span
          class="flex items-center gap-1 text-gray-500 dark:text-gray-400">
          <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"
            aria-hidden="true">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
              clip-rule="evenodd" />
          </svg>
          <span id="stat-pending" aria-label="Pending tasks">0</span>
        </span>
        <!-- Keyboard shortcuts help -->
        <div class="relative">
          <button id="help-toggle"
            class="w-8 h-8 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-sm cursor-pointer flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
            aria-expanded="false"
            aria-controls="help-panel"
            title="Keyboard shortcuts">
            ?
          </button>
          <div id="help-panel"
            class="hidden absolute top-full right-0 mt-2 p-4 bg-white dark:bg-gray-800 rounded-lg text-gray-800 dark:text-white text-sm z-50 min-w-64 border border-gray-200 dark:border-gray-700 shadow-lg">
            <h3 class="m-0 mb-3 font-semibold">Keyboard Shortcuts</h3>
            <dl
              class="m-0 grid grid-cols-[auto_1fr] gap-x-3 gap-y-1.5 text-sm">
              <dt class="text-gray-500 dark:text-gray-400"><kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">j</kbd>
                / <kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">↓</kbd></dt>
              <dd class="m-0">Next task</dd>
              <dt class="text-gray-500 dark:text-gray-400"><kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">k</kbd>
                / <kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">↑</kbd></dt>
              <dd class="m-0">Previous task</dd>
              <dt class="text-gray-500 dark:text-gray-400"><kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">Enter</kbd></dt>
              <dd class="m-0">Toggle task</dd>
              <dt class="text-gray-500 dark:text-gray-400"><kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">/</kbd></dt>
              <dd class="m-0">Search</dd>
              <dt class="text-gray-500 dark:text-gray-400"><kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">e</kbd></dt>
              <dd class="m-0">Expand all</dd>
              <dt class="text-gray-500 dark:text-gray-400"><kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">c</kbd></dt>
              <dd class="m-0">Collapse all</dd>
              <dt class="text-gray-500 dark:text-gray-400"><kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">f</kbd></dt>
              <dd class="m-0">Jump to first failure</dd>
              <dt class="text-gray-500 dark:text-gray-400"><kbd
                  class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">Esc</kbd></dt>
              <dd class="m-0">Clear search</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6"
      id="pipeline">
      {{ template "tasks-partial" dict "Tree" .Tree "RunID" .RunID "IsActive"
      .IsActive }}
    </div>
  </div>
</main>

{{ template "footer" }}
{{ template "end" }}

{{/* Tasks partial - used for htmx polling */}}
{{ define "tasks-partial" }}
<div class="space-y-4" id="tasks-container"
  {{ if and .RunID .IsActive }}
  hx-get="/runs/{{ .RunID }}/tasks-partial/"
  hx-trigger="load, every 3s"
  hx-target="#pipeline"
  hx-swap="morph:innerHTML"
  {{ end }}
  data-run-active="{{ if .IsActive }}true{{ else }}false{{ end }}">
  {{ template "renderPath" dict "Path" .Tree "Depth" 0 }}
</div>
{{ end }}

{{/* Helper function to get status color */}}
{{- define "getStatusColor" -}}
{{- $status := .Value.status -}}
{{- if eq $status "success" -}}
bg-green-100 border-green-200 dark:bg-green-900/30 dark:border-green-800
{{- else if eq $status "failure" -}}
bg-red-100 border-red-200 dark:bg-red-900/30 dark:border-red-800
{{- else if eq $status "error" -}}
bg-yellow-100 border-yellow-200 dark:bg-yellow-900/30 dark:border-yellow-800
{{- else if eq $status "running" -}}
bg-yellow-50 border-yellow-300 dark:bg-yellow-900/20 dark:border-yellow-700
{{- else if eq $status "abort" -}}
bg-gray-100 border-gray-200 dark:bg-gray-700 dark:border-gray-600
{{- else if eq $status "pending" -}}
bg-slate-100 border-slate-200 dark:bg-slate-700 dark:border-slate-600
{{- else -}}
bg-white border-gray-200 dark:bg-gray-800 dark:border-gray-700
{{- end -}}
{{- end -}}

{{/* Helper function to get status icon */}}
{{- define "getStatusIcon" -}}
{{- $status := .Value.status -}}
{{- if eq $status "success" -}}
<svg class="w-5 h-5 text-success" xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
  <path fill-rule="evenodd"
    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
    clip-rule="evenodd" />
</svg>
<span class="sr-only">Success</span>
{{- else if eq $status "failure" -}}
<svg class="w-5 h-5 text-failure" xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
  <path fill-rule="evenodd"
    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
    clip-rule="evenodd" />
</svg>
<span class="sr-only">Failed</span>
{{- else if eq $status "error" -}}
<svg class="w-5 h-5 text-error" xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
  <path fill-rule="evenodd"
    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
    clip-rule="evenodd" />
</svg>
<span class="sr-only">Error</span>
{{- else if eq $status "running" -}}
<svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 animate-spin"
  xmlns="http://www.w3.org/2000/svg"
  fill="none" viewBox="0 0 24 24" aria-hidden="true">
  <circle class="opacity-25" cx="12" cy="12" r="10"
    stroke="currentColor" stroke-width="4"></circle>
  <path class="opacity-75" fill="currentColor"
    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
</svg>
<span class="sr-only">Running</span>
{{- else if eq $status "abort" -}}
<svg class="w-5 h-5 text-abort" xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
  <path fill-rule="evenodd"
    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
    clip-rule="evenodd" />
</svg>
<span class="sr-only">Aborted</span>
{{- else if eq $status "pending" -}}
<svg class="w-5 h-5 text-notRun" xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
  <path fill-rule="evenodd"
    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
    clip-rule="evenodd" />
</svg>
<span class="sr-only">Pending</span>
{{- else -}}
<svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
  <path fill-rule="evenodd"
    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
    clip-rule="evenodd" />
</svg>
<span class="sr-only">Unknown status</span>
{{- end -}}
{{- end -}}

{{/* Get group color based on depth */}}
{{- define "getGroupColor" -}}
{{- $depth := . -}}
{{- $mod := mod $depth 8 -}}
{{- if eq $mod 0 -}}
border-blue-300 dark:border-blue-600
{{- else if eq $mod 1 -}}
border-purple-300 dark:border-purple-600
{{- else if eq $mod 2 -}}
border-orange-300 dark:border-orange-600
{{- else if eq $mod 3 -}}
border-teal-300 dark:border-teal-600
{{- else if eq $mod 4 -}}
border-pink-300 dark:border-pink-600
{{- else if eq $mod 5 -}}
border-green-300 dark:border-green-600
{{- else if eq $mod 6 -}}
border-red-300 dark:border-red-600
{{- else -}}
border-indigo-300 dark:border-indigo-600
{{- end -}}
{{- end -}}

{{/* Task template */}}
{{- define "renderTask" -}}
{{- $path := .Path -}}
{{- $order := .Order -}}
<details class="task-item 
    {{ template "getStatusColor" $path }} border rounded-md p-3 transition-all
  dark:text-gray-200"
  tabindex="0"
  data-task-id="{{ $path.FullPath }}"
  data-task-status="{{ $path.Value.status }}">
  <summary class="flex items-center justify-between cursor-pointer">
    <div class="flex items-center space-x-2">
      {{ template "getStatusIcon" $path }}
      <div class="flex items-center">
        <span
          class="inline-flex items-center justify-center w-6 h-6 mr-2 text-xs font-semibold rounded-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 dark:text-gray-200">
          {{ $order }}
        </span>
        <span class="font-medium">{{ $path.Name }}</span>
      </div>
    </div>
  </summary>
  <div
    class="task-details mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
    <div class="grid grid-cols-1 gap-4 text-sm">
      <div class="mb-4">
        <div id="player-{{ $path.FullPath | urlquery }}"
          class="w-full max-w-full overflow-x-hidden asciicast-container"
          data-asciicast-src="/asciicast/{{ $path.FullPath }}"></div>
      </div>
    </div>
  </div>
</details>
{{- end -}}

{{/* Group template - updated to show status if available */}}
{{- define "renderGroup" -}}
{{- $path := .Path -}}
{{- $depth := .Depth -}}
<div class="group-container border-l-4 pl-4 {{ template "getGroupColor" $depth
  }}">
  <div class="flex items-center justify-between mb-2">
    <div class="flex items-center">
      {{/* Show status icon if status exists */}}
      {{ if $path.Value.status }}
      <span class="mr-2">{{ template "getStatusIcon" $path }}</span>
      {{ end }}
      <div class="font-medium text-gray-700 dark:text-gray-300"><a
          href="/tasks{{ $path.FullPath }}/">{{
          $path.Name }}</a></div>
    </div>
    <a href="/graph{{ $path.FullPath }}/"
      class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/40 hover:bg-blue-200 dark:hover:bg-blue-800/60 text-blue-700 dark:text-blue-300 rounded transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-gray-800"
      title="View as graph">
      Graph
    </a>
  </div>
  <div class="space-y-2">
    {{/* Render children */}}
    {{ range $index, $child := $path.Children }}
    {{ template "renderPath" dict "Path" $child "Depth" (add $depth 1) "Order"
    (add $index 1) }}
    {{ end }}
  </div>
</div>
{{- end -}}

{{/* Main recursive path rendering - simplified with new methods */}}
{{ define "renderPath" }}
{{ $path := .Path }}
{{ $depth := .Depth }}
{{ $order := .Order }}

{{ if and $path.IsGroup (ne $path.Name "") }}
{{ template "renderGroup" dict "Path" $path "Depth" $depth }}
{{ else if ne $path.Name "" }}
{{ template "renderTask" dict "Path" $path "Order" $order }}
{{ else }}
{{ range $index, $child := $path.Children }}
{{ template "renderPath" dict "Path" $child "Depth" $depth "Order" (add $index
1) }}
{{ end }}
{{ end }}
{{ end }}
