assert:
  execution:
    # Test 1: Single var with 3 values (runs task 3 times)
    - "test-go-1.16"
    - "test-go-1.17"
    - "test-go-1.18"
    # Test 2: Two vars (2x3 = 6 combinations)
    - "build-linux-small"
    - "build-linux-medium"
    - "build-linux-large"
    - "build-darwin-small"
    - "build-darwin-medium"
    - "build-darwin-large"
    # Test 3: fail_fast stops at first failure
    - "failing-test-v1"
    # (v2 and v3 should not run due to fail_fast)

jobs:
  # Test 1: Basic across with single variable
  - name: test-across-single-var
    plan:
      - across:
          - var: go_version
            values: ["1.16", "1.17", "1.18"]
        task: test-go
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: sh
            args:
              - -c
              - |
                echo "Testing with Go version: $go_version"
                # Verify the environment variable is set correctly
                if [ -z "$go_version" ]; then
                  echo "ERROR: go_version not set"
                  exit 1
                fi
                echo "Go $go_version test passed"
        assert:
          code: 0

    assert:
      execution:
        - "test-go-1.16"
        - "test-go-1.17"
        - "test-go-1.18"

  # Test 2: Across with multiple variables (cartesian product)
  - name: test-across-multiple-vars
    plan:
      - across:
          - var: platform
            values: ["linux", "darwin"]
          - var: size
            values: ["small", "medium", "large"]
        task: build
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: sh
            args:
              - -c
              - |
                echo "Building for platform=$platform size=$size"
                # Verify both variables are set
                if [ -z "$platform" ] || [ -z "$size" ]; then
                  echo "ERROR: Variables not set correctly"
                  exit 1
                fi
                echo "Build completed: $platform-$size"
        assert:
          code: 0

    assert:
      execution:
        - "build-linux-small"
        - "build-linux-medium"
        - "build-linux-large"
        - "build-darwin-small"
        - "build-darwin-medium"
        - "build-darwin-large"

  # Test 3: Across with fail_fast (stops at first failure)
  - name: test-across-fail-fast
    plan:
      - across:
          - var: version
            values: ["v1", "v2", "v3"]
        fail_fast: true
        task: failing-test
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: sh
            args:
              - -c
              - |
                echo "Running test for version $version"
                # Always fail - this should stop after first iteration
                exit 1
        assert:
          code: 1
    on_failure:
      task: handle-failure
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: busybox
        run:
          path: echo
          args: ["Failure handled"]

    assert:
      execution:
        # Only first iteration should run due to fail_fast
        - "failing-test-v1"
        - "handle-failure"

  # Test 4: Across without fail_fast (runs all combinations even with failures)
  - name: test-across-no-fail-fast
    plan:
      - across:
          - var: test_id
            values: ["1", "2", "3"]
        fail_fast: false
        task: flaky-test
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: sh
            args:
              - -c
              - |
                echo "Running test $test_id"
                # Fail on test 2, succeed on others
                if [ "$test_id" = "2" ]; then
                  echo "Test $test_id failed"
                  exit 1
                fi
                echo "Test $test_id passed"
                exit 0
    on_failure:
      task: report-failures
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: busybox
        run:
          path: echo
          args: ["Some tests failed"]

    assert:
      execution:
        # All three should run despite middle one failing
        - "flaky-test-1"
        - "flaky-test-2"
        - "flaky-test-3"
        - "report-failures"

  # Test 5: Across with assertions on output
  - name: test-across-with-assertions
    plan:
      - across:
          - var: number
            values: ["1", "2", "3"]
        task: echo-number
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: sh
            args:
              - -c
              - |
                echo "Number is $number"
        assert:
          code: 0
          stdout: "Number is"

    assert:
      execution:
        - "echo-number-1"
        - "echo-number-2"
        - "echo-number-3"

  # Test 6: Across with three variables (2x2x2 = 8 combinations)
  - name: test-across-three-vars
    plan:
      - across:
          - var: env
            values: ["dev", "prod"]
          - var: region
            values: ["us", "eu"]
          - var: tier
            values: ["free", "paid"]
        task: deploy
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: sh
            args:
              - -c
              - |
                echo "Deploying to env=$env region=$region tier=$tier"
                # Verify all three variables are set
                if [ -z "$env" ] || [ -z "$region" ] || [ -z "$tier" ]; then
                  echo "ERROR: Not all variables set"
                  exit 1
                fi
        assert:
          code: 0

    assert:
      execution:
        - "deploy-dev-us-free"
        - "deploy-dev-us-paid"
        - "deploy-dev-eu-free"
        - "deploy-dev-eu-paid"
        - "deploy-prod-us-free"
        - "deploy-prod-us-paid"
        - "deploy-prod-eu-free"
        - "deploy-prod-eu-paid"

  # Test 7: Across combined with attempts (each iteration retries)
  - name: test-across-with-attempts
    plan:
      - across:
          - var: service
            values: ["api", "web"]
        task: deploy-service
        attempts: 2
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: echo
            args: ["Deploying service"]
        assert:
          code: 0

    assert:
      execution:
        # Each across iteration runs once (no retries needed as task succeeds)
        - "deploy-service-api"
        - "deploy-service-web"

  # Test 8: Across with ensure hook (ensure runs after all iterations)
  - name: test-across-with-ensure
    plan:
      - across:
          - var: component
            values: ["frontend", "backend"]
        task: test-component
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: echo
            args: ["Testing component"]
        assert:
          code: 0
        ensure:
          task: cleanup-test
          config:
            platform: linux
            image_resource:
              type: registry-image
              source:
                repository: busybox
            run:
              path: echo
              args: ["Cleaning up"]

    assert:
      execution:
        - "test-component-frontend"
        - "cleanup-test"
        - "test-component-backend"
        - "cleanup-test"
